name: Deploy to EKS

on:
  push:
    branches:
      - main

env:
  ECR_REGISTRY: 344299758316.dkr.ecr.us-east-1.amazonaws.com

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: AKIAVAKO5MLWOPQZQ6HW
        aws-secret-access-key: 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
        aws-region: us-east-1

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: Build starter image
      uses: docker/build-push-action@v2
      with:
        context: .
        push: false
        tags: ${{ env.ECR_REGISTRY }}/starter-repo:latest
        Dockerfile: Dockerfile.starter

    - name: Build worker image
      uses: docker/build-push-action@v2
      with:
        context: .
        push: false
        tags: ${{ env.ECR_REGISTRY }}/worker-repo:latest
        Dockerfile: Dockerfile.worker

    # - name: Apply worker deployment
    #   uses: actions/kubectl@v1
    #   env:
    #     KUBECONFIG: /github/home/.kube/config
    #   with:
    #     args: set image deployment/worker-deployment worker=${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}/worker-repo:${{ env.GITHUB_SHA }}

    # - name: Apply starter deployment
    #   uses: actions/kubectl@v1
    #   env:
    #     KUBECONFIG: /github/home/.kube/config
    #   with:
    #     args: set image deployment/starter-deployment starter=${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}/starter-repo:${{ env.GITHUB_SHA }}
